<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <!-- iOS: fullscreen (–Ω–∞ —ç–∫—Ä–∞–Ω –¥–æ–º–æ–π) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="@mind" />

  <!-- –¶–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç—É—Å–∞/–±—Ä–∞—É–∑–µ—Ä–∞ -->
  <meta name="theme-color" content="#050816" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#f6f7fb" media="(prefers-color-scheme: light)" />

  <!-- –ò–∫–æ–Ω–∫–∏ -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-v3.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="logo-192-v3.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="logo-192-v3.png" />

  <!-- manifest (Android/Chrome) -->
  <link rel="manifest" href="manifest.webmanifest" />

  <title>@mind</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --bg2:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.55);
      --card:rgba(255,255,255,.78);
      --card2:rgba(255,255,255,.62);
      --border:rgba(11,18,32,.12);
      --border2:rgba(109,94,252,.22);
      --accent:#6d5efc;
      --accent2:#a78bfa;
      --shadow: 0 12px 34px rgba(2,6,23,.12);
      --shadow2: 0 18px 50px rgba(109,94,252,.28);
      --radius:22px;

      --bottomBarH: 92px;

      /* select arrow (light) */
      --selectArrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%230b1220' d='M7 10l5 5l5-5z'/%3E%3C/svg%3E");
    }

    [data-theme="dark"]{
      --bg:#050816;
      --bg2:#070a1a;

      --text:#e9ecf3;
      --muted:rgba(233,236,243,.62);
      --card:rgba(7,10,26,.74);
      --card2:rgba(7,10,26,.62);

      --border:rgba(233,236,243,.14);
      --border2:rgba(167,139,250,.28);

      /* select arrow (dark) */
      --selectArrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%23e9ecf3' d='M7 10l5 5l5-5z'/%3E%3C/svg%3E");
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      min-height: 100%;
      margin: 0;
      background: var(--bg);
      color-scheme: light dark;
    }

    body {
      background-color: var(--bg);
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      touch-action: manipulation;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(900px 700px at 20% 10%, rgba(109,94,252,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 700px at 60% 92%, rgba(109,94,252,.10), transparent 70%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .app{
      height: calc(var(--vh, 1vh) * 100);
      display:flex;
      flex-direction:column;
    }

    .top{
      padding-left: 16px;
      padding-right: 16px;
      padding-bottom: 10px;
      padding-top: calc(16px + env(safe-area-inset-top));
    }

    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .h-title{ font-weight:900; font-size:18px; letter-spacing:.2px; color:var(--text); }
    .h-sub{ font-size:12px; color:var(--muted); }

    .iconBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      cursor:pointer;
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }

    .metrics{ display:flex; gap:10px; margin-top:12px; }
    .metric{
      flex:1;min-width:0;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .metric .k{ font-size:11px; color:var(--muted); }
    .metric .v{ margin-top:2px; font-size:16px; font-weight:900; color:var(--text); }

    .main{
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;

      padding: 0 16px;
      overflow:hidden;

      padding-bottom: calc(var(--bottomBarH) + env(safe-area-inset-bottom));
    }

    .sphereSection{
      width:100%;
      max-width:430px;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding-bottom: 8px;
    }

    .sphereWrap{
      position:relative;
      width: min(420px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius: 28px;
      overflow: hidden;
      background:
        radial-gradient(closest-side at 50% 44%, rgba(109,94,252,.14), transparent 68%),
        radial-gradient(closest-side at 60% 60%, rgba(167,139,250,.10), transparent 70%);
      touch-action:none;
    }

    .softGlow{
      position:absolute; inset:-40px;
      background: radial-gradient(closest-side, rgba(167,139,250,.18), transparent 70%);
      filter: blur(18px);
      opacity:.75;
      pointer-events:none;
      animation: breathe 4.6s ease-in-out infinite;
    }
    @keyframes breathe{ 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.06); } }

    .sphere{ position:absolute; inset:0; transform-style:preserve-3d; will-change:transform; }
    .node{ position:absolute; left:50%; top:50%; transform-style:preserve-3d; will-change:transform; }

    .chip{
      display:flex; align-items:center; gap:8px;
      padding: 9px 12px;
      border-radius: 18px;
      border: 1px solid var(--border2);
      background: var(--card2);
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 26px rgba(2,6,23,.10);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, filter .12s ease;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }
    .chip:active{ transform: scale(.98); }
    .chip .e{ font-size:16px; }

    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 8px 16px calc(8px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(255,255,255,0), var(--card));
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      justify-content:center;
      z-index:20;
    }
    [data-theme="dark"] .bottomBar{
      background: linear-gradient(180deg, rgba(0,0,0,0), var(--card));
    }

    .bottomStack{
      width: min(430px, 100%);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .primaryBtn{
      width: 100%;
      height: 52px;
      border-radius: 999px;
      border: 1px solid rgba(109,94,252,.25);
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(167,139,250,.85));
      color:#fff;
      font-weight: 950;
      letter-spacing:.2px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }

    .secondaryBtn{
      width:100%;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(109,94,252,.18);
      background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.52));
      color: var(--text);
      font-weight: 950;
      letter-spacing:.15px;
      box-shadow: 0 14px 42px rgba(2,6,23,.10);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      backdrop-filter: blur(14px);
    }
    [data-theme="dark"] .secondaryBtn{
      background: linear-gradient(135deg, rgba(7,10,26,.70), rgba(7,10,26,.52));
      border-color: rgba(167,139,250,.20);
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      color: var(--text);
    }

    .tinyBtn{
      width:100%;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(109,94,252,.18);
      background: rgba(255,255,255,.42);
      color: var(--text);
      font-weight: 950;
      letter-spacing:.12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 28px rgba(2,6,23,.08);
    }
    [data-theme="dark"] .tinyBtn{
      background: rgba(7,10,26,.46);
      border-color: rgba(167,139,250,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.38);
    }

    .modalBg{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .modalBg.show{ display:flex; }

    .modal{
      width: min(560px, 100%);
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(14px);
      max-height: 86vh;
      overflow:auto;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }

    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{ font-weight: 950; font-size: 14px; color: var(--text); }
    .modalHint{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .editor{
      margin-top:12px;
      min-height: 220px;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 15px;
      line-height: 1.4;
      overflow:auto;
      -webkit-user-select:text;
      user-select:text;
    }
    .editor:empty:before{ content: attr(data-placeholder); color: var(--muted); }

    .saveBtn{
      margin-top:12px;
      width: 100%;
      height: 48px;
      border-radius: 18px;
      border: 1px solid rgba(109,94,252,.25);
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(167,139,250,.80));
      color:#fff;
      font-weight: 950;
      cursor:pointer;
    }

    .journalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .journalTitle{ font-weight: 950; font-size: 14px; color: var(--text); }

    .journalRight{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .filterSelect{
      height: 40px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background-color: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      padding: 0 38px 0 10px;
      outline: none;
      max-width: 220px;
      cursor: pointer;

      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      background-image: var(--selectArrow);
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 18px 18px;
    }

    .emptyBox{
      margin-top:10px;
      border:1px dashed var(--border);
      border-radius: 18px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      background: rgba(255,255,255,.03);
    }

    .entry{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
      position:relative;
    }

    .entryTop{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:start;
      gap:10px;
      font-size:12px;
      color: var(--muted);
    }

    /* Emoji —Å–µ–∫—Ç–æ—Ä–∞ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞) */
    .entryBadge{
      display:flex;
      align-items:center;
    }

    .entryBadge .segEmoji{
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      line-height: 1;
      flex: 0 0 32px;
    }
.entryTag{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      color: var(--text);
      min-width:0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-height: 28px;
    }

    .segEmoji{
      width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      flex: 0 0 22px;
    }

    .entryRight{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      align-items:center;
      gap:8px;
    }

    .entryDate{
      font-size:11px;
      color: var(--muted);
      margin-left: 6px;
      white-space: nowrap;
    }

    .progressPill{
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-weight: 900;
      font-size: 11px;
      min-width: 56px;
      text-align:center;
      user-select:none;
    }

    .miniBtn{
      width:32px;
      height:32px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .pinBtn.pinned{
      background: rgba(109,94,252,.14);
      border-color: rgba(109,94,252,.24);
    }

    .entryText{
      margin-top:8px;
      font-size: 14px;
      line-height: 1.4;
      color: var(--text);
      overflow-wrap: anywhere;
    }

    .pop{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.04);
    }
    .popTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color: var(--muted);
    }
    .popVal{ font-weight: 950; color: var(--text); }

    .rangeWrap{ margin-top:10px; }

    input[type="range"]{
      -webkit-appearance:none;
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.10);
      outline:none;
    }
    [data-theme="dark"] input[type="range"]{
      background: rgba(233,236,243,.12);
    }

    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--accent);
      border: 2px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 22px rgba(2,6,23,.20);
      cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--accent);
      border: 2px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 22px rgba(2,6,23,.20);
      cursor:pointer;
    }

    .progressGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    .pCard{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
    }
    .pRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pTitle{ font-weight:950; font-size:13px; color:var(--text); }
    .pSub{ font-size:12px; color:var(--muted); }

    canvas{
      width:100%;
      height:auto;
      display:block;
    }

    .noSelect{
      user-select:none;
      -webkit-user-select:none;
    }

    
    /* ---------- Meditation ---------- */
    .medModal{
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }
    .medTabs{
      margin-top:10px;
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      backdrop-filter: blur(10px);
    }
    .medTabBtn{
      flex:1;
      height: 40px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 950;
      cursor:pointer;
    }
    .medTabBtn.active{
      color: var(--text);
      border-color: rgba(109,94,252,.25);
      background: linear-gradient(135deg, rgba(109,94,252,.20), rgba(167,139,250,.12));
      box-shadow: 0 12px 34px rgba(109,94,252,.12);
    }

    .medGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .medField{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 10px;
    }
    .medFieldWide{ grid-column: 1 / -1; }
    .medLabel{
      font-size: 11px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom:8px;
    }
    .medSelect{
      width:100%;
      max-width:none;
      height: 42px;
      border-radius: 14px;
    }
    .medToggleRow{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .medToggle{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 13px;
      color: var(--text);
      font-weight: 900;
      user-select:none;
    }
    .medToggle input{
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .medMini{ display:flex; flex-direction:column; gap:6px; }
    .medMiniTitle{ font-weight: 950; font-size: 12px; color: var(--text); }
    .medMiniText{ font-size: 12px; color: var(--muted); line-height: 1.35; }

    .medStatsGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .medStatCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
    }
    .medStatK{ font-size: 11px; color: var(--muted); font-weight: 900; }
    .medStatV{ margin-top:4px; font-size: 16px; font-weight: 950; color: var(--text); }
    .medStatS{ margin-top:2px; font-size: 11px; color: var(--muted); }

    .medHistory{
      margin-top:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
    }
    .medHistoryTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .medHistoryTitle{ font-weight: 950; font-size: 13px; color: var(--text); }
    .medHistoryRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .medHistoryRow:first-child{ border-top:none; padding-top:0; }
    .medHistoryLeft{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .medHistoryMain{ font-weight: 950; font-size: 13px; color: var(--text); }
    .medHistorySub{ font-size: 11px; color: var(--muted); }
    .medHistoryRight{ display:flex; flex-direction:column; gap:2px; align-items:flex-end; }
    .medBadge{
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-weight: 950;
      font-size: 11px;
      user-select:none;
      white-space:nowrap;
    }

    .medRun{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .medRunTop{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      padding: 10px 0 2px;
    }
    .medRunTimer{
      font-weight: 950;
      font-size: 34px;
      letter-spacing: .5px;
      color: var(--text);
    }
    .medRunPhase{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      text-align:center;
    }

    .medVisualWrap{
      position:relative;
      width:100%;
      border-radius: 22px;
      border:1px solid var(--border);
      background:
        radial-gradient(closest-side at 50% 42%, rgba(109,94,252,.18), transparent 62%),
        radial-gradient(closest-side at 60% 60%, rgba(167,139,250,.12), transparent 70%),
        rgba(255,255,255,.02);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    #medCanvas{
      width:100%;
      display:block;
    }
    .medVisualOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .medCue{
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(109,94,252,.25);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      font-weight: 950;
      color: var(--text);
      letter-spacing:.2px;
    }
    [data-theme="dark"] .medCue{
      background: rgba(7,10,26,.46);
    }

    .medControls{
      display:flex;
      gap:10px;
    }
    .medMicroHint{
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      line-height:1.35;
    }

    .medDone{
      margin-top:12px;
    }
    .medDoneCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .medDoneTitle{
      font-weight: 950;
      font-size: 18px;
      color: var(--text);
    }
    .medDoneSub{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .medDoneGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .medDoneStat{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 10px 12px;
    }
    .medDoneK{ font-size:11px; color:var(--muted); font-weight:900; }
    .medDoneV{ margin-top:4px; font-size:15px; color:var(--text); font-weight:950; }

    @media (max-width: 420px){
      .medGrid{ grid-template-columns: 1fr; }
      .medStatsGrid{ grid-template-columns: 1fr 1fr; }
      .medRunTimer{ font-size: 32px; }
    }


    @media (max-width: 420px){
      .h-title{ font-size: 17px; }
      .h-sub{ font-size: 11px; }
      .metric .v{ font-size: 15px; }
      .chip{ font-size: 11px; padding: 8px 10px; border-radius: 16px; }
      .chip .e{ font-size: 15px; }
      .entryText{ font-size: 13px; line-height: 1.35; }
      .modal{ border-radius: 22px; padding: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
      .secondaryBtn{ height: 42px; }
      .primaryBtn{ height: 50px; }
      .filterSelect{ max-width: 160px; }
      .tinyBtn{ height: 36px; }
    }

    #progressModal {
      max-height: min(560px, calc(var(--vh, 1vh) * 100 - 120px));
      overflow: auto;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="header">
        <div class="brand">
          <div class="h-title">@mind</div>
          <div class="h-sub"><3</div>
        </div>
        <button class="iconBtn noSelect" id="themeBtn" aria-label="–¢–µ–º–∞" title="–¢–µ–º–∞">üåì</button>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="k">–°–µ—Ä–∏—è –¥–Ω–µ–π</div>
          <div class="v" id="mStreak">0 üî•</div>
        </div>
        <div class="metric">
          <div class="k">–°–µ–≥–æ–¥–Ω—è</div>
          <div class="v" id="mToday">0 üìù</div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="sphereSection">
        <div class="sphereWrap" id="sphereWrap">
          <div class="softGlow"></div>
          <div class="sphere" id="sphere"></div>
        </div>
      </div>
    </div>

    <div class="bottomBar" id="bottomBar">
      <div class="bottomStack">
        <!-- –ø–æ—Ä—è–¥–æ–∫: –û—Ç–∫—Ä—ã—Ç—å –¥–Ω–µ–≤–Ω–∏–∫ —Å–≤–µ—Ä—Ö—É -->
        <button class="primaryBtn noSelect" id="openJournalBtn">
          <span style="font-size:18px">üìì</span>
          <span>–û—Ç–∫—Ä—ã—Ç—å –¥–Ω–µ–≤–Ω–∏–∫</span>
        </button>

        <button class="secondaryBtn noSelect" id="openAffBtn">
          <span style="font-size:16px">üìö</span>
          <span>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–π</span>
        </button>

        <button class="tinyBtn noSelect" id="openProgressBtn">
          <span style="font-size:15px">üìä</span>
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
        </button>

        <button class="tinyBtn noSelect" id="openMedBtn">
          <span style="font-size:15px">üßò</span>
          <span>–ú–µ–¥–∏—Ç–∞—Ü–∏—è</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Entry editor modal -->
  <div class="modalBg" id="entryModalBg">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="modalTitle" id="entryTitle">üìù –ó–∞–ø–∏—Å—å</div>
        <button class="iconBtn noSelect" id="entryClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="modalHint" id="entryHint"></div>

      <div class="editor" id="editor" contenteditable="true"
        data-placeholder="–ü–∏—à–∏ –∫–∞–∫ –≤ –ª–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–º."></div>

      <button class="saveBtn noSelect" id="saveEntryBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- Journal modal -->
  <div class="modalBg" id="journalModalBg">
    <div class="modal" id="journalModal" role="dialog" aria-modal="true">
      <div class="journalHeader">
        <div class="journalTitle">üìì –î–Ω–µ–≤–Ω–∏–∫</div>

        <div class="journalRight">
          <select class="filterSelect" id="journalFilter" aria-label="–§–∏–ª—å—Ç—Ä –∑–∞–ø–∏—Å–µ–π">
            <option value="">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>
          </select>

          <button class="iconBtn noSelect" id="journalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>
      </div>

      <div id="journalBody"></div>
    </div>
  </div>

  <!-- Progress modal -->
  <div class="modalBg" id="progressModalBg">
    <div class="modal" id="progressModal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="modalTitle">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
        <button class="iconBtn noSelect" id="progressClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="modalHint">–°—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ % –ø–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º –¥–Ω–µ–≤–Ω–∏–∫–∞.</div>

      <div class="progressGrid">
        <div class="pCard">
          <div class="pRow">
            <div>
              <div class="pTitle">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
              <div class="pSub" id="pMeta">0 –∑–∞–ø–∏—Å–µ–π</div>
            </div>
            <div class="pTitle" id="pTotal">0%</div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="donutCanvas" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Meditation modal -->
  <div class="modalBg" id="medModalBg">
    <div class="modal medModal" id="medModal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="modalTitle">üßò –ú–µ–¥–∏—Ç–∞—Ü–∏—è</div>
        <button class="iconBtn noSelect" id="medClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>

      <div class="medTabs">
        <button class="medTabBtn noSelect active" data-tab="start">–°—Ç–∞—Ä—Ç</button>
        <button class="medTabBtn noSelect" data-tab="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </div>

      <!-- Start / settings -->
      <div class="medTab" id="medTabStart">
        <div class="modalHint" style="margin-top:8px">
          –ë—ã—Å—Ç—Ä–∞—è —Å–µ—Å—Å–∏—è, –¥—ã—Ö–∞–Ω–∏–µ –∏ —Ñ–æ–∫—É—Å. –í—Å—ë —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî —Å–º–æ–∂–µ—à—å –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–µ–¥–µ–ª—è–º.
        </div>

        <div class="medGrid">
          <div class="medField">
            <div class="medLabel">–í—Ä–µ–º—è</div>
            <select class="filterSelect medSelect" id="medDuration" aria-label="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–µ–¥–∏—Ç–∞—Ü–∏–∏">
              <option value="180">3 –º–∏–Ω—É—Ç—ã</option>
              <option value="300" selected>5 –º–∏–Ω—É—Ç</option>
              <option value="480">8 –º–∏–Ω—É—Ç</option>
              <option value="600">10 –º–∏–Ω—É—Ç</option>
              <option value="900">15 –º–∏–Ω—É—Ç</option>
              <option value="1200">20 –º–∏–Ω—É—Ç</option>
            </select>
          </div>

          <div class="medField">
            <div class="medLabel">–°—Ç–∏–ª—å</div>
            <select class="filterSelect medSelect" id="medStyle" aria-label="–°—Ç–∏–ª—å –º–µ–¥–∏—Ç–∞—Ü–∏–∏">
              <option value="breath_44">–ö–ª–∞—Å—Å–∏–∫–∞ (–≤–¥–æ—Ö/–≤—ã–¥–æ—Ö)</option>
              <option value="box_4444">–ü—Ä–∞–Ω–∞—è–º–∞ (–≤–¥–æ—Ö/–∑–∞–¥–µ—Ä–∂–∫–∞/–≤—ã–¥–æ—Ö/–∑–∞–¥–µ—Ä–∂–∫–∞)</option>
              <option value="silent">–°–≤–æ–±–æ–¥–Ω–∞—è (—Ç–∞–π–º–µ—Ä)</option>
            </select>
          </div>
<div class="medField medFieldWide">
            <div class="medMini">
              <div class="medMiniTitle">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
              <div class="medMiniText" id="medPreviewHint">–°—è–¥—å —É–¥–æ–±–Ω–æ. –†–∞—Å—Å–ª–∞–±—å –ø–ª–µ—á–∏. –î—ã—à–∏ —Å–ø–æ–∫–æ–π–Ω–æ.</div>
            </div>
          </div>
        </div>

        <button class="primaryBtn noSelect" id="medStartBtn" style="margin-top:12px">
          <span style="font-size:18px">‚ñ∂Ô∏è</span>
          <span>–ù–∞—á–∞—Ç—å –º–µ–¥–∏—Ç–∞—Ü–∏—é</span>
        </button>
      </div>

      <!-- Stats -->
      <div class="medTab" id="medTabStats" style="display:none;">
        <div class="modalHint" style="margin-top:8px">
          –ù–µ–¥–µ–ª—è —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞. –°–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
        </div>

        <div class="medStatsGrid" id="medStatsGrid"></div>

        <div class="medHistory">
          <div class="medHistoryTop">
            <div class="medHistoryTitle">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏</div>
            <button class="secondaryBtn noSelect" id="medClearBtn" style="height:42px; border-radius:16px; width:auto; padding:0 14px;">
              –û—á–∏—Å—Ç–∏—Ç—å
            </button>
          </div>
          <div id="medHistoryBody"></div>
        </div>
      </div>

      <!-- Running (full-screen inside modal) -->
      <div class="medRun" id="medRun" style="display:none;">
        <div class="medRunTop">
          <div class="medRunTimer" id="medTimer">05:00</div>
          <div class="medRunPhase" id="medPhase">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶</div>
        </div>

        <div class="medVisualWrap">
          <canvas id="medCanvas" height="360"></canvas>
          <div class="medVisualOverlay">
            <div class="medCue" id="medCue">–í–¥–æ—Ö</div>
          </div>
        </div>

        <div class="medControls">
          <button class="secondaryBtn noSelect" id="medPauseBtn" style="flex:1">
            ‚è∏ –ü–∞—É–∑–∞
          </button>
          <button class="tinyBtn noSelect" id="medStopBtn" style="flex:1">
            ‚èπ –ó–∞–∫–æ–Ω—á–∏—Ç—å
          </button>
        </div>

        <div class="medMicroHint" id="medMicroHint">–ú—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥—ã—Ö–∞–Ω–∏—é.</div>
      </div>

      <!-- Summary -->
      <div class="medDone" id="medDone" style="display:none;">
        <div class="medDoneCard">
          <div class="medDoneTitle">–ì–æ—Ç–æ–≤–æ ‚úÖ</div>
          <div class="medDoneSub" id="medDoneSub">5 –º–∏–Ω—É—Ç. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.</div>

          <div class="medDoneGrid" id="medDoneGrid"></div>

          <button class="primaryBtn noSelect" id="medDoneBtn" style="margin-top:12px">
            <span style="font-size:18px">‚ú®</span>
            <span>–í–µ—Ä–Ω—É—Ç—å—Å—è</span>
          </button>

          <button class="secondaryBtn noSelect" id="medDoneToStatsBtn" style="margin-top:8px">
            <span style="font-size:16px">üìà</span>
            <span>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Affirmations modal -->
  <div class="modalBg" id="affModalBg">
    <div class="modal" id="affModal" role="dialog" aria-modal="true">
      <div class="journalHeader">
        <div class="journalTitle">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–π</div>
        <button class="iconBtn noSelect" id="affClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>

      <div class="modalHint">–î–æ–±–∞–≤–ª—è–π —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—á–µ—à—å –ø–æ–≤—Ç–æ—Ä—è—Ç—å.</div>

      <div class="affTopRow" style="display:flex; gap:10px; margin-top:10px;">
        <textarea class="affInput" id="affInput" rows="2"
          style="flex:1;min-height:44px;max-height:120px;border:1px solid var(--border);border-radius:16px;padding:10px 12px;background:transparent;color:var(--text);font-size:14px;line-height:1.35;outline:none;resize:none;"
          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ø –≤—ã–±–∏—Ä–∞—é –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ."></textarea>
        <button class="affAddBtn noSelect" id="affAddBtn"
          style="width:52px;height:52px;border-radius:16px;border:1px solid rgba(109,94,252,.25);background:linear-gradient(135deg, rgba(109,94,252,.95), rgba(167,139,250,.80));color:#fff;font-weight:950;cursor:pointer;box-shadow:var(--shadow2);display:flex;align-items:center;justify-content:center;user-select:none;"
          title="–î–æ–±–∞–≤–∏—Ç—å">Ôºã</button>
      </div>

      <div id="affBody"></div>
    </div>
  </div>

  <script>
    // --------- Data ----------
    const segments = [
      { id: 1,  name: "–ú—ã—Å–ª–∏",           emoji: "üí≠" },
      { id: 2,  name: "–ß—É–≤—Å—Ç–≤–∞",         emoji: "üòî" },
      { id: 3,  name: "–°–∞–º–æ–æ—Ü–µ–Ω–∫–∞",      emoji: "‚ú®" },
      { id: 4,  name: "–ú—ã—à–ª–µ–Ω–∏–µ",        emoji: "üß†" },
      { id: 5,  name: "–¢—Ä–µ–≤–æ–≥–∞",         emoji: "üåô" },
      { id: 6,  name: "–ú–æ—Ç–∏–≤–∞—Ü–∏—è",       emoji: "üî•" },
      { id: 7,  name: "–†–æ—Å—Ç",            emoji: "ü¶ã" },
      { id: 8,  name: "–ò–Ω—Ç—É–∏—Ü–∏—è",        emoji: "üßø" },
      { id: 9,  name: "–°—Ç—Ä–∞—Ö–∏",          emoji: "üíî" },
      { id: 10, name: "–õ—é–±–æ–≤—å –∫ —Å–µ–±–µ",   emoji: "üíñ" },
      { id: 11, name: "–≠–Ω–µ—Ä–≥–∏—è",         emoji: "üõå" },
      { id: 12, name: "–ú–µ—á—Ç–∞",           emoji: "üíº" },
      { id: 13, name: "–î–µ–Ω—å–≥–∏",          emoji: "üí∏" },
      { id: 14, name: "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å",   emoji: "üå∏" },
      { id: 15, name: "–Ø—Å–Ω–æ—Å—Ç—å",         emoji: "üß©" },
      { id: 16, name: "–≠–º–æ—Ü–∏–∏",          emoji: "üåä" },
      { id: 17, name: "–í–∏–¥–µ–Ω–∏–µ",         emoji: "üîÆ" },
      { id: 18, name: "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ",     emoji: "üïä" },
      { id: 19, name: "–°–∏–ª–∞",            emoji: "‚ö°Ô∏è" },
      { id: 20, name: "–°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç", emoji: "üìù" },
    ];

    const hintsBySegment = {};

    const LS = {
      theme: "mind_theme",
      entries: "mind_entries_v4",
      streak: "mind_streak_v1",
      affs: "mind_affs_v1",
      meds: "mind_meds_v1"
    };

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch{
        return fallback;
      }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function nowMs(){ return Date.now(); }
    function nowISO(){ return new Date().toISOString(); }
    function dayKeyFromMs(ms){ return new Date(ms).toISOString().slice(0,10); }
    function dayKeyFromISO(iso){ return new Date(iso).toISOString().slice(0,10); }

    function progressColor(percent){
      const p = Math.max(0, Math.min(100, percent));
      const hue = 0 + (120 * (p / 100));
      return `hsl(${hue} 85% 45%)`;
    }
    function setRangeGradient(rangeEl, percent){
      const c = progressColor(percent);
      const neutralLight = "rgba(11,18,32,.12)";
      const neutralDark  = "rgba(233,236,243,.14)";
      const neutral = (document.body.dataset.theme === "dark") ? neutralDark : neutralLight;
      rangeEl.style.background =
        `linear-gradient(90deg, ${c} 0%, ${c} ${percent}%, ${neutral} ${percent}%, ${neutral} 100%)`;
    }

    // --------- State ----------
    let entries = loadJSON(LS.entries, []).map(e => ({
      ...e,
      pinned: !!e.pinned,
      progress: typeof e.progress === "number" ? e.progress : 0,
    }));

    let streakState = loadJSON(LS.streak, null);
    if(!streakState || typeof streakState !== "object"){
      streakState = { streak: 0, lastActiveAt: 0, lastActiveDay: "" };
      saveJSON(LS.streak, streakState);
    }

    let affs = loadJSON(LS.affs, []).map(a => ({ ...a, pinned: !!a.pinned }));


    // Meditation sessions
    let medSessions = loadJSON(LS.meds, []).map(s => ({
      ...s,
      completed: !!s.completed,
      targetSec: Number(s.targetSec || 0),
      actualSec: Number(s.actualSec || 0),
      startedAt: s.startedAt || "",
      endedAt: s.endedAt || "",
      style: s.style || "silent",
    }));

    let activeSegment = null;

    // ============================
    // ‚úÖ Sphere: –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π trackball-rotation
    // ============================
    let isDragging = false;
    let dragPointerId = null;

    // –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ 3x3 (row-major)
    let R = [ 1,0,0,  0,1,0,  0,0,1 ];

    // –∏–Ω–µ—Ä—Ü–∏—è
    let inertAxis = [0,1,0];     // –æ—Å—å
    let inertSpeed = 0.0012;     // —Ä–∞–¥/–∫–∞–¥—Ä
    const inertFriction = 0.94;  // –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
    const inertMin = 0.00002;

    let lastMoveT = 0;
    let lastV = null;

    let sphereScale = 1.0;

    let openProgressForId = null;
    let journalFilterSegId = "";

    // --------- Elements ----------
    const themeBtn = document.getElementById("themeBtn");
    const mStreak = document.getElementById("mStreak");
    const mToday  = document.getElementById("mToday");

    const sphereWrap = document.getElementById("sphereWrap");
    const sphereEl   = document.getElementById("sphere");

    const bottomBar = document.getElementById("bottomBar");

    const entryModalBg = document.getElementById("entryModalBg");
    const entryTitle   = document.getElementById("entryTitle");
    const entryHint    = document.getElementById("entryHint");
    const entryClose   = document.getElementById("entryClose");
    const editor       = document.getElementById("editor");
    const saveEntryBtn = document.getElementById("saveEntryBtn");

    const journalModalBg = document.getElementById("journalModalBg");
    const journalModal   = document.getElementById("journalModal");
    const journalClose   = document.getElementById("journalClose");
    const journalBody    = document.getElementById("journalBody");
    const openJournalBtn = document.getElementById("openJournalBtn");
    const journalFilter  = document.getElementById("journalFilter");

    const openAffBtn = document.getElementById("openAffBtn");
    const affModalBg = document.getElementById("affModalBg");
    const affClose   = document.getElementById("affClose");
    const affBody    = document.getElementById("affBody");
    const affInput   = document.getElementById("affInput");
    const affAddBtn  = document.getElementById("affAddBtn");

    // Progress UI
    const openProgressBtn = document.getElementById("openProgressBtn");
    const progressModalBg = document.getElementById("progressModalBg");
    const progressClose   = document.getElementById("progressClose");
    const pTotal          = document.getElementById("pTotal");
    const pMeta           = document.getElementById("pMeta");
    const donutCanvas     = document.getElementById("donutCanvas");

    // Meditation UI
    const openMedBtn   = document.getElementById("openMedBtn");
    const medModalBg   = document.getElementById("medModalBg");
    const medModal     = document.getElementById("medModal");
    const medClose     = document.getElementById("medClose");

    const medTabBtns   = Array.from(document.querySelectorAll('.medTabBtn'));
    const medTabStart  = document.getElementById("medTabStart");
    const medTabStats  = document.getElementById("medTabStats");

    const medDuration  = document.getElementById("medDuration");
    const medStyle     = document.getElementById("medStyle");
    const medPreviewHint = document.getElementById("medPreviewHint");

    const medStartBtn  = document.getElementById("medStartBtn");
    const medRun       = document.getElementById("medRun");
    const medTimer     = document.getElementById("medTimer");
    const medPhase     = document.getElementById("medPhase");
    const medCue       = document.getElementById("medCue");
    const medCanvas    = document.getElementById("medCanvas");
    const medPauseBtn  = document.getElementById("medPauseBtn");
    const medStopBtn   = document.getElementById("medStopBtn");
    const medMicroHint = document.getElementById("medMicroHint");

    const medDone      = document.getElementById("medDone");
    const medDoneSub   = document.getElementById("medDoneSub");
    const medDoneGrid  = document.getElementById("medDoneGrid");
    const medDoneBtn   = document.getElementById("medDoneBtn");
    const medDoneToStatsBtn = document.getElementById("medDoneToStatsBtn");

    const medStatsGrid = document.getElementById("medStatsGrid");
    const medHistoryBody = document.getElementById("medHistoryBody");
    const medClearBtn  = document.getElementById("medClearBtn");


    // --------- Theme ----------
    function initTheme(){
      const t = localStorage.getItem(LS.theme);
      document.body.dataset.theme = (t === "dark") ? "dark" : "light";
    }
    function toggleTheme(){
      const cur = document.body.dataset.theme === "dark" ? "dark" : "light";
      const next = cur === "dark" ? "light" : "dark";
      document.body.dataset.theme = next;
      localStorage.setItem(LS.theme, next);

      const openRange = document.querySelector('input[type="range"][data-open="1"]');
      if(openRange){
        setRangeGradient(openRange, Number(openRange.value));
      }

      if(progressModalBg.classList.contains("show")){
        requestAnimationFrame(() => renderProgressModal());
      }
    }

    // --------- VH for iOS ----------
    function setVh(){
      document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
    }

    // --------- Bottom bar height ----------
    function updateBottomBarHeight(){
      if(!bottomBar) return;
      const rect = bottomBar.getBoundingClientRect();
      const h = Math.max(68, Math.round(rect.height) + 2);
      document.documentElement.style.setProperty("--bottomBarH", h + "px");
    }

    // --------- Streak ----------
    function normalizeStreakOnBoot(){
      const now = nowMs();
      const last = Number(streakState.lastActiveAt || 0);
      if(!last) return;

      const diff = now - last;
      const dayNow = dayKeyFromMs(now);
      if(diff > 24 * 60 * 60 * 1000){
        streakState.streak = 0;
        streakState.lastActiveDay = dayNow;
        saveJSON(LS.streak, streakState);
      }
    }

    function registerActivityForStreak(){
      const now = nowMs();
      const dayNow = dayKeyFromMs(now);

      if(streakState.lastActiveAt && (now - streakState.lastActiveAt) > 24*60*60*1000){
        streakState.streak = 0;
      }
      if(streakState.lastActiveDay !== dayNow){
        streakState.streak = (Number(streakState.streak) || 0) + 1;
        streakState.lastActiveDay = dayNow;
      }
      streakState.lastActiveAt = now;
      saveJSON(LS.streak, streakState);
    }

    // --------- Metrics ----------
    function computeMetrics(){
      const today = dayKeyFromMs(nowMs());
      const todayCount = entries.filter(e => dayKeyFromISO(e.createdAt) === today).length;
      const streak = Number(streakState.streak || 0);
      return { streak, todayCount };
    }
    function renderMetrics(){
      const m = computeMetrics();
      mStreak.textContent = `${m.streak} üî•`;
      mToday.textContent  = `${m.todayCount} üìù`;
    }

    // --------- Sphere ----------
    const nodes = [];

    function buildSphere(){
      sphereEl.innerHTML = "";
      nodes.length = 0;

      for(let i=0;i<segments.length;i++){
        const seg = segments[i];
        const node = document.createElement("div");
        node.className = "node";

        const chip = document.createElement("div");
        chip.className = "chip noSelect";
        chip.innerHTML = `<span class="e">${seg.emoji}</span><span>${seg.name}</span>`;
        chip.addEventListener("click", (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          openEntry(seg);
        });

        node.appendChild(chip);
        sphereEl.appendChild(node);
        nodes.push({ node, chip, seg });
      }

      fillJournalFilterOptions();
      layoutSphere();
    }

    function fillJournalFilterOptions(){
      journalFilter.innerHTML = `<option value="">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>`;
      for(const s of segments){
        const opt = document.createElement("option");
        opt.value = String(s.id);
        opt.textContent = `${s.emoji} ${s.name}`;
        journalFilter.appendChild(opt);
      }
      journalFilter.value = journalFilterSegId;
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    // ---------- Trackball math ----------
    function dot(a,b){ return a[0]*b[0] + a[1]*b[1] + a[2]*b[2]; }
    function cross(a,b){
      return [
        a[1]*b[2] - a[2]*b[1],
        a[2]*b[0] - a[0]*b[2],
        a[0]*b[1] - a[1]*b[0]
      ];
    }
    function norm(v){ return Math.sqrt(dot(v,v)); }
    function normalize(v){
      const n = norm(v);
      if(!n) return [0,0,0];
      return [v[0]/n, v[1]/n, v[2]/n];
    }

    function matMul(A,B){
      // 3x3 row-major
      return [
        A[0]*B[0] + A[1]*B[3] + A[2]*B[6],
        A[0]*B[1] + A[1]*B[4] + A[2]*B[7],
        A[0]*B[2] + A[1]*B[5] + A[2]*B[8],

        A[3]*B[0] + A[4]*B[3] + A[5]*B[6],
        A[3]*B[1] + A[4]*B[4] + A[5]*B[7],
        A[3]*B[2] + A[4]*B[5] + A[5]*B[8],

        A[6]*B[0] + A[7]*B[3] + A[8]*B[6],
        A[6]*B[1] + A[7]*B[4] + A[8]*B[7],
        A[6]*B[2] + A[7]*B[5] + A[8]*B[8],
      ];
    }

    function matVec(M,v){
      return [
        M[0]*v[0] + M[1]*v[1] + M[2]*v[2],
        M[3]*v[0] + M[4]*v[1] + M[5]*v[2],
        M[6]*v[0] + M[7]*v[1] + M[8]*v[2],
      ];
    }

    function rotFromAxisAngle(axis, angle){
      const a = normalize(axis);
      const x=a[0], y=a[1], z=a[2];
      const c = Math.cos(angle);
      const s = Math.sin(angle);
      const t = 1 - c;
      return [
        t*x*x + c,     t*x*y - s*z,   t*x*z + s*y,
        t*x*y + s*z,   t*y*y + c,     t*y*z - s*x,
        t*x*z - s*y,   t*y*z + s*x,   t*z*z + c
      ];
    }

    // –ü—Ä–æ–µ–∫—Ü–∏—è —Ç–æ—á–∫–∏ —ç–∫—Ä–∞–Ω–∞ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å—Ñ–µ—Ä—É:
    // ‚úÖ –≤–∞–∂–Ω–æ–µ: Y –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã "–≤–≤–µ—Ä—Ö –ø–∞–ª—å—Ü–µ–º" = "–≤–≤–µ—Ä—Ö –ø–æ —Å—Ñ–µ—Ä–µ"
    function projectToTrackball(clientX, clientY){
      const rect = sphereWrap.getBoundingClientRect();
      const cx = rect.left + rect.width  / 2;
      const cy = rect.top  + rect.height / 2;
      const r  = Math.min(rect.width, rect.height) / 2;

      let x = (clientX - cx) / r;
      let y = (clientY - cy) / r; 
      const d2 = x*x + y*y;

      if(d2 <= 1){
        const z = Math.sqrt(1 - d2);
        return [x,y,z];
      } else {
        // –≤–Ω–µ –∫—Ä—É–≥–∞ ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å (z=0)
        const inv = 1 / Math.sqrt(d2);
        x *= inv; y *= inv;
        return [x,y,0];
      }
    }

    function layoutSphere(){
      const rect = sphereWrap.getBoundingClientRect();
      const radius = Math.min(rect.width, rect.height) * 0.36;
      const len = nodes.length || 1;

      for(let i=0;i<len;i++){
        const item = nodes[i];

        
        // —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ —Å—Ñ–µ—Ä–µ
        const phi = Math.acos(-1 + (2*i)/len);
        const theta = Math.sqrt(len * Math.PI) * phi;

        // –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞ —Å—Ñ–µ—Ä–µ (–≤ "–º–∏—Ä–æ–≤—ã—Ö" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
        const base = [
          Math.sin(phi) * Math.cos(theta),
          Math.sin(phi) * Math.sin(theta),
          Math.cos(phi),
        ];

        // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–≤–æ—Ä–æ—Ç trackball
        const v = matVec(R, base);

        const x1 = v[0] * radius;
        const y1 = v[1] * radius;
        const z2 = v[2] * radius;

        const depth = (z2 + radius) / (2*radius);
        const scale = 0.55 + depth * 0.55;
        const opacity = 0.28 + depth * 0.72;

        item.node.style.transform = `translate3d(calc(-50% + ${x1}px), calc(-50% + ${y1}px), 0)`;
        item.node.style.zIndex = String(Math.floor(scale * 1000));

        item.chip.style.transform = `scale(${(scale * sphereScale).toFixed(4)})`;
        item.chip.style.opacity = opacity.toFixed(3);
        item.chip.style.filter = opacity < 0.42 ? "blur(0.2px)" : "none";
      }
    }

    function onDragStart(e){
      isDragging = true;
      dragPointerId = e.pointerId;
      lastMoveT = performance.now();
      lastV = projectToTrackball(e.clientX, e.clientY);

      // –ø—Ä–∏ –Ω–æ–≤–æ–º –∫–∞—Å–∞–Ω–∏–∏ ‚Äî –Ω–µ –∫—Ä—É—Ç–∏–º –∞–≤—Ç–æ—Å–ø–∏–Ω–æ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
      inertSpeed = 0;
    }

    function onDragMove(e){
      if(!isDragging) return;
      if(dragPointerId !== e.pointerId) return;

      const v1 = projectToTrackball(e.clientX, e.clientY);
      const v0 = lastV || v1;

      // axis = v0 x v1 (–≤–∞–∂–Ω–æ: –ø–æ—Ä—è–¥–æ–∫ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –¥–ª—è "–∑–∞ –ø–∞–ª—å—Ü–µ–º")
      const axis = cross(v0, v1);
      const axisN = norm(axis);

      if(axisN > 1e-6){
        const d = clamp(dot(v0, v1), -1, 1);
        const angle = Math.acos(d);

        // –º–∞–ª–µ–Ω—å–∫–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ –º—è–≥–∫–æ, –Ω–æ "–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ"
        const k = 1.0;
        const rot = rotFromAxisAngle(axis, angle * k);

        // –Ω–æ–≤—ã–π –ø–æ–≤–æ—Ä–æ—Ç: rot * R
        R = matMul(rot, R);

        // –∏–Ω–µ—Ä—Ü–∏—è: –æ—Ü–µ–Ω–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const t = performance.now();
        const dt = Math.max(8, t - lastMoveT); // ms
        lastMoveT = t;

        inertAxis = normalize(axis);
        inertSpeed = (angle / (dt / 16.67)); // "—Ä–∞–¥/–∫–∞–¥—Ä" –ø—Ä–∏–º–µ—Ä–Ω–æ
        inertSpeed = clamp(inertSpeed, 0, 0.08);
      }

      lastV = v1;
      layoutSphere();
    }

    function onDragEnd(e){
      if(dragPointerId !== e.pointerId) return;
      isDragging = false;
      dragPointerId = null;
      lastV = null;
    }

    function animate(){
      if(!isDragging){
        if(inertSpeed > inertMin){
          const rot = rotFromAxisAngle(inertAxis, inertSpeed);
          R = matMul(rot, R);
          inertSpeed *= inertFriction;
        } else {
          // –º—è–≥–∫–∏–π –∞–≤—Ç–æ—Å–ø–∏–Ω, —á—Ç–æ–±—ã —Å—Ñ–µ—Ä–∞ "–∂–∏–ª–∞"
          const rot = rotFromAxisAngle([0,1,0], 0.00135);
          R = matMul(rot, R);
        }
        layoutSphere();
      }
      requestAnimationFrame(animate);
    }

    sphereWrap.addEventListener("wheel", (e) => {
      e.preventDefault();
      sphereScale += e.deltaY * -0.001;
      sphereScale = Math.min(Math.max(0.6, sphereScale), 1.5);
      layoutSphere();
    }, { passive:false });

    // ‚úÖ –í–∞–∂–Ω–æ: preventDefault + pointer capture ‚Äî —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    sphereWrap.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      sphereWrap.setPointerCapture?.(e.pointerId);
      onDragStart(e);
    }, { passive:false });

    sphereWrap.addEventListener("pointermove", (e) => {
      e.preventDefault();
      onDragMove(e);
    }, { passive:false });

    sphereWrap.addEventListener("pointerup", (e) => {
      e.preventDefault();
      onDragEnd(e);
    }, { passive:false });

    sphereWrap.addEventListener("pointercancel", (e) => {
      e.preventDefault();
      onDragEnd(e);
    }, { passive:false });

    // --------- Entry modal ----------
    function pickHint(segId){
      return "–ó–∞–ø–∏—à–∏ –æ–¥–Ω—É –º—ã—Å–ª—å –∫–æ—Ä–æ—Ç–∫–æ –∏ —á–µ—Å—Ç–Ω–æ.";
    }

    function openEntry(seg){
      activeSegment = seg;
      entryTitle.textContent = `${seg.emoji} ${seg.name}`;
      entryHint.textContent = pickHint(seg.id);
      editor.textContent = "";
      entryModalBg.classList.add("show");
      setTimeout(() => editor.focus(), 0);
    }

    function closeEntry(){
      entryModalBg.classList.remove("show");
      activeSegment = null;
      editor.textContent = "";
      setTimeout(() => { setVh(); updateBottomBarHeight(); }, 50);
    }

    function escapeHtmlToParagraphs(text){
      const safe = text
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
      return safe.split("\n").map(line => line ? line : "&nbsp;").join("<br>");
    }

    function saveEntry(){
      if(!activeSegment) return;
      const text = (editor.textContent || "").trim();
      if(!text) return;

      const entry = {
        id: crypto.randomUUID(),
        segmentId: activeSegment.id,
        segmentName: activeSegment.name,
        segmentEmoji: activeSegment.emoji,
        html: escapeHtmlToParagraphs(text),
        createdAt: nowISO(),
        pinned: false,
        progress: 0
      };

      entries.push(entry);
      saveJSON(LS.entries, entries);

      registerActivityForStreak();
      renderMetrics();
      closeEntry();
    }

    // --------- Journal ----------
    function openJournal(){
      openProgressForId = null;
      renderJournal();
      journalModalBg.classList.add("show");
    }
    function closeJournal(){
      let journalScrollBeforeProgress = 0;
      journalModalBg.classList.remove("show");
      openProgressForId = null;
      journalScrollBeforeProgress = 0;
      setTimeout(setVh, 50);
      setTimeout(() => { setVh(); updateBottomBarHeight(); }, 50);
    }

    function togglePin(entryId){
      const idx = entries.findIndex(e => e.id === entryId);
      if(idx === -1) return;
      entries[idx].pinned = !entries[idx].pinned;
      saveJSON(LS.entries, entries);
      renderJournal();
    }

    function toggleProgressMenu(entryId){
      const wasOpen = openProgressForId;
      const next = (wasOpen === entryId) ? null : entryId;

      if(!wasOpen && next){
        journalScrollBeforeProgress = journalModal.scrollTop;
      }

      openProgressForId = next;
      renderJournal();

      if(openProgressForId){
        requestAnimationFrame(() => {
          const entryEl = journalBody.querySelector(`[data-id="${openProgressForId}"]`);
          if(!entryEl) return;
          ensureEntryPopoverVisible(journalModal, entryEl);
        });
        return;
      }

      requestAnimationFrame(() => {
        journalModal.scrollTop = journalScrollBeforeProgress;
      });
    }

    function ensureEntryPopoverVisible(modalEl, entryEl){
      const pop = entryEl.querySelector(".pop");
      if(!pop || pop.style.display === "none") return;

      const mRect = modalEl.getBoundingClientRect();
      const pRect = pop.getBoundingClientRect();

      const topSafe = mRect.top + 72;
      const bottomSafe = mRect.bottom - 24;

      if(pRect.bottom > bottomSafe){
        const delta = pRect.bottom - bottomSafe + 8;
        modalEl.scrollTop += delta;
      } else if(pRect.top < topSafe){
        const delta = topSafe - pRect.top + 8;
        modalEl.scrollTop -= delta;
      }
    }

    function setProgress(entryId, value){
      const idx = entries.findIndex(e => e.id === entryId);
      if(idx === -1) return;
      entries[idx].progress = value;
      saveJSON(LS.entries, entries);
      renderJournal();
    }

    function deleteEntry(entryId){
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if(!ok) return;
      entries = entries.filter(e => e.id !== entryId);
      saveJSON(LS.entries, entries);
      renderMetrics();
      renderJournal();
    }

    function renderJournal(){
      journalBody.innerHTML = "";

      const filterId = journalFilterSegId ? Number(journalFilterSegId) : null;
      const filteredEntries = filterId
        ? entries.filter(e => Number(e.segmentId) === filterId)
        : entries.slice();

      if(filteredEntries.length === 0){
        const empty = document.createElement("div");
        empty.className = "emptyBox";
        empty.innerHTML =
          `<div style="font-weight:900; color:var(--text); margin-bottom:6px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
           <div>–ù–∞–∂–º–∏ –Ω–∞ –ª—é–±–æ–π —Å–µ–∫—Ç–æ—Ä –Ω–∞ —Å—Ñ–µ—Ä–µ –∏ —Å–¥–µ–ª–∞–π –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.</div>`;
        journalBody.appendChild(empty);
        return;
      }

      const pinned = filteredEntries.filter(e => e.pinned).sort((a,b) => a.createdAt < b.createdAt ? 1 : -1);
      const normal = filteredEntries.filter(e => !e.pinned).sort((a,b) => a.createdAt < b.createdAt ? 1 : -1);
      const sorted = [...pinned, ...normal];

      for(const e of sorted){
        const block = document.createElement("div");
        block.className = "entry";
        block.dataset.id = e.id;

        const dt = new Date(e.createdAt);
        const when = dt.toLocaleString();

        const pct = Math.max(0, Math.min(100, Number(e.progress || 0)));
        const pctColor = progressColor(pct);
        
        block.innerHTML = `
        <div class="entryTop">
        <div></div> <!-- –ø—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Å–ø—Ä–∞–≤–∞ -->
        
        <div class="entryRight">
        <div class="entryBadge" title="${e.segmentName}"><span class="segEmoji">${e.segmentEmoji}</span></div>
        <div class="progressPill" style="border-color:${pctColor}33;">
        <span style="color:${pctColor};">${pct}%</span>
        </div>
        <button class="miniBtn noSelect progressBtn" title="–ü—Ä–æ–≥—Ä–µ—Å—Å">üìà</button>
        <button class="miniBtn noSelect pinBtn ${e.pinned ? "pinned":""}" title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">üìå</button>
        <button class="miniBtn noSelect delBtn" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        <span class="entryDate">${when}</span>
        </div>
        </div>

          <div class="entryText"></div>

  <div class="pop" style="display:${openProgressForId === e.id ? "block" : "none"};">
  <div class="popTop">
  <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
  <div class="popVal"><span style="color:${pctColor};">${pct}%</span></div>
  </div>
  <div class="rangeWrap">
  <input type="range" min="0" max="100" step="1" value="${pct}" data-open="${openProgressForId === e.id ? "1":"0"}">
  </div>
  </div>
  `;


        const textEl = block.querySelector(".entryText");
        textEl.innerHTML = e.html;

        const pinBtn = block.querySelector(".pinBtn");
        const progBtn = block.querySelector(".progressBtn");
        const delBtn  = block.querySelector(".delBtn");
        const range   = block.querySelector('input[type="range"]');

        pinBtn.addEventListener("click", () => togglePin(e.id));
        progBtn.addEventListener("click", () => toggleProgressMenu(e.id));
        delBtn.addEventListener("click", () => deleteEntry(e.id));

        if(range){
          setRangeGradient(range, pct);

          range.addEventListener("input", () => {
            const v = Number(range.value);
            setRangeGradient(range, v);

            const valEl = block.querySelector(".popVal");
            const pill  = block.querySelector(".progressPill");
            const c = progressColor(v);

            valEl.innerHTML = `<span style="color:${c};">${v}%</span>`;
            pill.innerHTML  = `<span style="color:${c};">${v}%</span>`;
            pill.style.borderColor = `${c}33`;
          });

          range.addEventListener("change", () => {
            const v = Number(range.value);
            setProgress(e.id, v);
          });
        }

        journalBody.appendChild(block);
      }
    }

    // --------- Affirmations ----------
    function openAff(){
      renderAffs();
      affModalBg.classList.add("show");
      setTimeout(() => affInput.focus(), 0);
    }
    function closeAff(){
      affModalBg.classList.remove("show");
      setTimeout(() => { setVh(); updateBottomBarHeight(); }, 50);
    }

    function addAff(){
      const raw = (affInput.value || "").trim();
      if(!raw) return;

      const item = {
        id: crypto.randomUUID(),
        text: raw,
        createdAt: nowISO(),
        pinned: false
      };
      affs.push(item);
      saveJSON(LS.affs, affs);
      affInput.value = "";
      renderAffs();
    }

    function toggleAffPin(id){
      const idx = affs.findIndex(a => a.id === id);
      if(idx === -1) return;
      affs[idx].pinned = !affs[idx].pinned;
      saveJSON(LS.affs, affs);
      renderAffs();
    }

    function deleteAff(id){
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—é?");
      if(!ok) return;
      affs = affs.filter(a => a.id !== id);
      saveJSON(LS.affs, affs);
      renderAffs();
    }

    function escapeText(t){
      return (t || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderAffs(){
      affBody.innerHTML = "";

      if(affs.length === 0){
        const empty = document.createElement("div");
        empty.className = "emptyBox";
        empty.innerHTML =
          `<div style="font-weight:900; color:var(--text); margin-bottom:6px;">–ü–æ–∫–∞ –Ω–µ—Ç –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–π</div>
           <div>–î–æ–±–∞–≤—å –æ–¥–Ω—É —Ñ—Ä–∞–∑—É –≤—ã—à–µ ‚Äî –∫–æ—Ä–æ—Ç–∫—É—é, —è—Å–Ω—É—é –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é.</div>`;
        affBody.appendChild(empty);
        return;
      }

      const pinned = affs.filter(a => a.pinned).sort((a,b) => a.createdAt < b.createdAt ? 1 : -1);
      const normal = affs.filter(a => !a.pinned).sort((a,b) => a.createdAt < b.createdAt ? 1 : -1);
      const sorted = [...pinned, ...normal];

      for(const a of sorted){
        const block = document.createElement("div");
        block.className = "entry";
        block.dataset.id = a.id;

        const dt = new Date(a.createdAt);
        const when = dt.toLocaleString();
        const quoted = `¬´${escapeText(a.text)}¬ª`;

        block.innerHTML = `
          <div class="entryTop">
            <div class="entryTag" title="–ê—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—è">
              <span style="font-size:16px">‚ú®</span>
            </div>

            <div class="entryRight">
              <button class="miniBtn noSelect pinBtn ${a.pinned ? "pinned":""}" title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">üìå</button>
              <button class="miniBtn noSelect delBtn" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
              <span class="entryDate">${when}</span>
            </div>
          </div>

          <div class="entryText" style="font-weight:900;">${quoted}</div>
        `;

        block.querySelector(".pinBtn").addEventListener("click", () => toggleAffPin(a.id));
        block.querySelector(".delBtn").addEventListener("click", () => deleteAff(a.id));

        affBody.appendChild(block);
      }
    }

    // --------- Progress modal ----------
    function getOverallProgress(){
      if(!entries.length) return 0;
      const sum = entries.reduce((acc, e) => acc + (Number(e.progress) || 0), 0);
      return Math.round(sum / entries.length);
    }

    function drawDonut(percent){
      const canvas = donutCanvas;
      if (!canvas) return;

      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const cssW = Math.max(220, Math.floor(canvas.parentElement?.clientWidth || 320));
      const cssH = 220;

      canvas.style.width = cssW + "px";
      canvas.style.height = cssH + "px";
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, cssW, cssH);

      const p = Math.max(0, Math.min(100, Number(percent) || 0)) / 100;

      const w = cssW, h = cssH;
      const cx = Math.floor(w / 2);
      const cy = Math.floor(h / 2);

      const radius = Math.min(w, h) * 0.36;
      const thickness = Math.max(10, Math.floor(radius * 0.28));

      ctx.lineCap = "round";
      ctx.lineWidth = thickness;

      ctx.beginPath();
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      ctx.stroke();

      const start = -Math.PI / 2;
      const end = start + Math.PI * 2 * p;

      const grad = ctx.createLinearGradient(cx - radius, cy - radius, cx + radius, cy + radius);
      grad.addColorStop(0, "rgba(72,202,228,0.95)");
      grad.addColorStop(1, "rgba(255,140,200,0.85)");

      ctx.beginPath();
      ctx.strokeStyle = grad;
      ctx.arc(cx, cy, radius, start, end);
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "bold 28px Courier New, monospace";
      ctx.fillText(Math.round(p * 100) + "%", cx, cy - 2);

      ctx.fillStyle = "rgba(255,255,255,0.65)";
      ctx.font = "12px Courier New, monospace";
      ctx.fillText("–∑–∞ –Ω–µ–¥–µ–ª—é", cx, cy + 22);
    }

    function renderProgressModal(){
      const total = getOverallProgress();
      const count = entries.length;

      pTotal.textContent = `${total}%`;
      pMeta.textContent = `${count} ${count===1 ? "–∑–∞–ø–∏—Å—å" : (count>=2 && count<=4 ? "–∑–∞–ø–∏—Å–∏" : "–∑–∞–ø–∏—Å–µ–π")}`;

      drawDonut(total);
    }

    function openProgress(){
      progressModal.scrollTop = 0;
      progressModalBg.classList.add("show");
      requestAnimationFrame(() => {
        renderProgressModal();
      });
    }

    function closeProgress(){
      progressModalBg.classList.remove("show");
      progressModal.scrollTop = 0;
      setTimeout(() => { setVh(); updateBottomBarHeight(); }, 50);
    }

    

    // --------- Meditation ----------

    const MED = {
      styles: {
        breath_44: { name: "–ö–ª–∞—Å—Å–∏–∫–∞", cycle: [ ["–í–¥–æ—Ö",4], ["–í—ã–¥–æ—Ö",4] ], hint: "–°–ª–µ–¥–∏ –∑–∞ –¥–≤–∏–∂–µ–Ω–∏–µ–º –∫—Ä—É–≥–∞. –í–¥–æ—Ö ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ. –í—ã–¥–æ—Ö ‚Äî —Å–∂–∞—Ç–∏–µ." },
        box_4444:  { name: "–ü—Ä–∞–Ω–∞—è–º–∞", cycle: [ ["–í–¥–æ—Ö",4], ["–ó–∞–¥–µ—Ä–∂–∫–∞",4], ["–í—ã–¥–æ—Ö",4], ["–ó–∞–¥–µ—Ä–∂–∫–∞",4] ], hint: "–†–æ–≤–Ω–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ. –ï—Å–ª–∏ —Ç—è–∂–µ–ª–æ ‚Äî –¥—ã—à–∏ –º—è–≥—á–µ, –º–æ–∂–Ω–æ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫." },
        silent:    { name: "–°–≤–æ–±–æ–¥–Ω–∞—è", cycle: [ ["–§–æ–∫—É—Å",999999] ], hint: "–ü—Ä–æ—Å—Ç–æ —Å–∏–¥–∏. –ó–∞–º–µ—á–∞–π –º—ã—Å–ª–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –¥—ã—Ö–∞–Ω–∏—é." },
      }
    };

    let medActive = null; // {id,targetSec,style,bell,ambient,startedAtMs,paused,totalPausedMs,pauseStartedMs,endedAtMs,completed}
    let medTickRaf = 0;
    let medCanvasRaf = 0;
    let medLastCue = "";
    let medCountdown = 0; // 3..0
    let medCanvasState = { t0: 0, w: 0, h: 0, dpr: 1, dots: [] };

    function saveMeds(){ saveJSON(LS.meds, medSessions); }

    function fmtMMSS(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
    }

    function isoFromMs(ms){ return new Date(ms).toISOString(); }

    function startOfWeekMs(dateMs){
      const d = new Date(dateMs);
      const day = (d.getDay() + 6) % 7; // Mon=0
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d.getTime();
    }

    function switchMedTab(tab){
      for(const b of medTabBtns){
        const is = b.dataset.tab === tab;
        b.classList.toggle("active", is);
      }
      medTabStart.style.display = (tab === "start") ? "block" : "none";
      medTabStats.style.display = (tab === "stats") ? "block" : "none";

      // hide run/done when switching
      if(tab === "stats"){
        medRun.style.display = "none";
        medDone.style.display = "none";
        renderMedStats();
      }
    }

    function updateMedPreview(){
      const styleKey = medStyle.value || "silent";
      const st = MED.styles[styleKey] || MED.styles.silent;
      medPreviewHint.textContent = st.hint;
    }

    function openMeditation(){
      // reset UI state
      cancelMedLoops();
      medRun.style.display = "none";
      medDone.style.display = "none";
      medTabStart.style.display = "block";
      medTabStats.style.display = "none";
      switchMedTab("start");
      updateMedPreview();

      medModalBg.classList.add("show");
      // Canvas sizes need layout
      requestAnimationFrame(() => {
        if(medModalBg.classList.contains("show")){
          updateMedCanvasSize();
          drawMedCanvas(0, "idle");
        }
      });
    }

    function closeMeditation(){
      // if running ‚Äî stop safely but do not auto-save as complete
      if(medActive){
        stopMeditation(false);
      }
      medModalBg.classList.remove("show");
      cancelMedLoops();
      setTimeout(() => { setVh(); updateBottomBarHeight(); }, 50);
    }

    function cancelMedLoops(){
      if(medTickRaf){ cancelAnimationFrame(medTickRaf); medTickRaf = 0; }
      if(medCanvasRaf){ cancelAnimationFrame(medCanvasRaf); medCanvasRaf = 0; }
    }

    function updateMedCanvasSize(){
      if(!medCanvas) return;
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const cssW = Math.max(240, Math.floor(medCanvas.parentElement?.clientWidth || 320));
      // height adaptive: a bit taller on big screens, but safe
      const cssH = Math.max(280, Math.min(420, Math.floor(cssW * 0.92)));

      medCanvas.style.width = cssW + "px";
      medCanvas.style.height = cssH + "px";
      medCanvas.width = Math.floor(cssW * dpr);
      medCanvas.height = Math.floor(cssH * dpr);

      const ctx = medCanvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      medCanvasState.dpr = dpr;
      medCanvasState.w = cssW;
      medCanvasState.h = cssH;

      // seed dots once per resize
      const dotCount = Math.max(18, Math.min(42, Math.floor(cssW / 10)));
      medCanvasState.dots = Array.from({length: dotCount}).map(() => ({
        a: Math.random() * Math.PI * 2,
        r: 0.22 + Math.random() * 0.55,
        s: 0.15 + Math.random() * 0.55,
        p: 0.3 + Math.random() * 0.7,
      }));
    }

    function beginMeditation(){
      if(medActive) return;

      const targetSec = Number(medDuration.value || 300);
      const styleKey = medStyle.value || "silent";
      const st = MED.styles[styleKey] || MED.styles.silent;

      // UI swap to run mode
      medTabStart.style.display = "none";
      medTabStats.style.display = "none";
      for(const b of medTabBtns){ b.classList.remove("active"); }

      medRun.style.display = "flex";
      medDone.style.display = "none";

      medMicroHint.textContent = st.hint;

      updateMedCanvasSize();
      medCanvasState.t0 = performance.now();

      medActive = {
        id: crypto.randomUUID(),
        targetSec,
        style: styleKey,
        startedAtMs: Date.now(),
        paused: false,
        totalPausedMs: 0,
        pauseStartedMs: 0,
        completed: false,
      };

      // 3-2-1 countdown for calmer start
      medCountdown = 3;
      medPhase.textContent = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶";
      medCue.textContent = "–ì–æ—Ç–æ–≤–∏–º—Å—è";
      medTimer.textContent = fmtMMSS(targetSec);
      tickMeditation(); // schedules itself
      animateMedCanvas(); // schedules itself
    }

    function getElapsedSec(){
      if(!medActive) return 0;
      const now = Date.now();
      const pausedExtra = medActive.paused ? (now - medActive.pauseStartedMs) : 0;
      const elapsedMs = (now - medActive.startedAtMs) - medActive.totalPausedMs - pausedExtra;
      return Math.max(0, elapsedMs / 1000);
    }

    function getRemainingSec(){
      if(!medActive) return 0;
      const rem = medActive.targetSec - getElapsedSec();
      return rem;
    }

    function getCycleState(styleKey, elapsedSec){
      const st = MED.styles[styleKey] || MED.styles.silent;
      if(styleKey === "silent") return { label: "–§–æ–∫—É—Å", phase: "–§–æ–∫—É—Å", progress: 0.5 };

      const cycle = st.cycle;
      const total = cycle.reduce((a, it) => a + it[1], 0);
      const t = elapsedSec % total;

      let acc = 0;
      for(const [label, dur] of cycle){
        if(t < acc + dur){
          const inside = t - acc;
          const phaseProg = dur ? (inside / dur) : 0;
          return { label, phase: label, progress: phaseProg, phaseDur: dur, phaseInside: inside, cycleTotal: total };
        }
        acc += dur;
      }
      return { label: cycle[0][0], phase: cycle[0][0], progress: 0 };
    }

    function tickMeditation(){
      if(!medActive) return;

      if(medActive.paused){
        medTimer.textContent = fmtMMSS(getRemainingSec());
        medPhase.textContent = "–ü–∞—É–∑–∞";
        medCue.textContent = "–ü–∞—É–∑–∞";
        medTickRaf = requestAnimationFrame(tickMeditation);
        return;
      }

      // countdown
      if(medCountdown > 0){
        medCue.textContent = String(medCountdown);
        medPhase.textContent = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶";
        medCountdown -= 1;
        medTickRaf = requestAnimationFrame(() => {
          // wait ~1s using time check
          const t0 = performance.now();
          const wait = () => {
            if(!medActive || medActive.paused) return;
            if(performance.now() - t0 >= 950){
              tickMeditation();
            }else{
              medTickRaf = requestAnimationFrame(wait);
            }
          };
          wait();
        });
        return;
      }

      const elapsed = getElapsedSec();
      const rem = getRemainingSec();

      medTimer.textContent = fmtMMSS(rem);

      const cyc = getCycleState(medActive.style, elapsed);
      medPhase.textContent = (medActive.style === "silent") ? "–§–æ–∫—É—Å –Ω–∞ –¥—ã—Ö–∞–Ω–∏–∏" : `–°–µ–π—á–∞—Å: ${cyc.phase}`;
      medCue.textContent = cyc.label;

      if(rem <= 0.15){
        stopMeditation(true);
        return;
      }

      medTickRaf = requestAnimationFrame(tickMeditation);
    }

    function animateMedCanvas(){
      if(!medActive) return;

      const now = performance.now();
      const t = (now - (medCanvasState.t0 || now)) / 1000;

      let mode = "idle";
      let amp = 0.4;
      if(medActive.paused){
        mode = "paused";
        amp = 0.18;
      }else if(medCountdown > 0){
        mode = "countdown";
        amp = 0.22;
      }else{
        mode = "run";
        amp = 0.45;
      }

      drawMedCanvas(t, mode);

      medCanvasRaf = requestAnimationFrame(animateMedCanvas);
    }

    function drawMedCanvas(t, mode){
      if(!medCanvas) return;
      const ctx = medCanvas.getContext("2d");
      if(!ctx) return;

      const w = medCanvasState.w || (medCanvas.clientWidth || 320);
      const h = medCanvasState.h || 360;

      ctx.clearRect(0,0,w,h);

      // Background subtle grid-ish
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,w,h);

      // Determine breathing scale
      let s = 0.55;
      let cue = "–§–æ–∫—É—Å";

      if(medActive){
        if(mode === "paused"){
          s = 0.52 + 0.02 * Math.sin(t*2);
          cue = "–ü–∞—É–∑–∞";
        }else if(mode === "countdown"){
          s = 0.50 + 0.03 * Math.sin(t*3.2);
          cue = "–ì–æ—Ç–æ–≤–∏–º—Å—è";
        }else{
          const elapsed = getElapsedSec();
          const stKey = medActive.style || "silent";
          if(stKey === "silent"){
            s = 0.56 + 0.04 * Math.sin(t*1.2);
            cue = "–§–æ–∫—É—Å";
          }else{
            const cyc = getCycleState(stKey, elapsed);
            cue = cyc.label;

            // map phase to expansion/contraction
            // Inhale: expand; Exhale: contract; Hold: steady w/ micro pulse
            if(cyc.label === "–í–¥–æ—Ö"){
              s = 0.48 + 0.24 * cyc.progress;
            }else if(cyc.label === "–í—ã–¥–æ—Ö"){
              s = 0.72 - 0.24 * cyc.progress;
            }else{ // hold
              s = 0.72 + 0.01 * Math.sin(t*3.4);
            }
          }
        }
      }

      // Core orb
      const cx = w/2;
      const cy = h/2;
      const R = Math.min(w,h) * 0.26;
      const r = R * s;

      // glow
      const g1 = ctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r*2.4);
      g1.addColorStop(0, "rgba(109,94,252,0.26)");
      g1.addColorStop(1, "rgba(109,94,252,0)");
      ctx.fillStyle = g1;
      ctx.beginPath();
      ctx.arc(cx, cy, r*2.2, 0, Math.PI*2);
      ctx.fill();

      // main gradient
      const g2 = ctx.createRadialGradient(cx - r*0.35, cy - r*0.35, r*0.2, cx, cy, r);
      g2.addColorStop(0, "rgba(167,139,250,0.92)");
      g2.addColorStop(0.55, "rgba(109,94,252,0.82)");
      g2.addColorStop(1, "rgba(109,94,252,0.16)");

      ctx.fillStyle = g2;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.fill();

      // subtle ring
      ctx.strokeStyle = "rgba(233,236,243,0.18)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, r*1.04, 0, Math.PI*2);
      ctx.stroke();

      // orbit dots
      const dots = medCanvasState.dots || [];
      for(const d of dots){
        const a = d.a + t * d.s * 0.7;
        const rr = r * (1.35 + d.r);
        const x = cx + Math.cos(a) * rr;
        const y = cy + Math.sin(a) * rr * 0.86;

        const alpha = 0.10 + 0.25 * d.p;
        ctx.fillStyle = `rgba(233,236,243,${alpha})`;
        ctx.beginPath();
        ctx.arc(x, y, 1.2 + d.p*1.8, 0, Math.PI*2);
        ctx.fill();
      }

      // bottom fade for depth
      const fade = ctx.createLinearGradient(0, cy, 0, h);
      fade.addColorStop(0, "rgba(0,0,0,0)");
      fade.addColorStop(1, "rgba(0,0,0,0.14)");
      ctx.fillStyle = fade;
      ctx.fillRect(0,0,w,h);
    }

    function togglePause(){
      if(!medActive) return;
      if(medActive.paused){
        // resume
        medActive.paused = false;
        const now = Date.now();
        medActive.totalPausedMs += (now - medActive.pauseStartedMs);
        medActive.pauseStartedMs = 0;
        medPauseBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
      }else{
        // pause
        medActive.paused = true;
        medActive.pauseStartedMs = Date.now();
        medPauseBtn.textContent = "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
      }
    }

    function stopMeditation(markCompleted){
      if(!medActive) return;

      const endedAtMs = Date.now();
      const elapsed = getElapsedSec();
      const actualSec = Math.max(0, Math.round(elapsed));
      const completed = !!markCompleted;

      medActive.endedAtMs = endedAtMs;
      medActive.completed = completed;

      cancelMedLoops();
      // persist
      const session = {
        id: medActive.id,
        style: medActive.style,
        targetSec: medActive.targetSec,
        actualSec,
        startedAt: isoFromMs(medActive.startedAtMs),
        endedAt: isoFromMs(endedAtMs),
        completed,
      };
      medSessions.push(session);
      saveMeds();

      // UI summary
      showMeditationDone(session);

      medActive = null;
      medCountdown = 0;
    }

    function showMeditationDone(session){
      medRun.style.display = "none";
      medDone.style.display = "block";

      const mins = Math.round(session.actualSec / 60);
      const sName = (MED.styles[session.style]?.name) || "–ú–µ–¥–∏—Ç–∞—Ü–∏—è";
      const doneText = session.completed
        ? `${mins || 1} –º–∏–Ω ‚Ä¢ ${sName}. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.`
        : `–ó–∞–≤–µ—Ä—à–µ–Ω–æ –¥–æ—Å—Ä–æ—á–Ω–æ ‚Ä¢ ${mins || 1} –º–∏–Ω ‚Ä¢ ${sName}. –í—Å—ë —Ä–∞–≤–Ω–æ –∑–∞—á—ë—Ç.`;

      medDoneSub.textContent = doneText;

      // compute week stats quickly
      const now = Date.now();
      const weekStart = startOfWeekMs(now);
      const thisWeek = medSessions.filter(x => new Date(x.startedAt).getTime() >= weekStart);
      const weekCount = thisWeek.length;
      const weekMin = Math.round(thisWeek.reduce((a,x)=>a + (Number(x.actualSec)||0),0) / 60);

      const compRate = (() => {
        if(!thisWeek.length) return 0;
        const c = thisWeek.filter(x=>x.completed).length;
        return Math.round((c/thisWeek.length)*100);
      })();

      medDoneGrid.innerHTML = `
        <div class="medDoneStat">
          <div class="medDoneK">–°–µ—Å—Å–∏–π –Ω–∞ –Ω–µ–¥–µ–ª–µ</div>
          <div class="medDoneV">${weekCount}</div>
        </div>
        <div class="medDoneStat">
          <div class="medDoneK">–ú–∏–Ω—É—Ç –Ω–∞ –Ω–µ–¥–µ–ª–µ</div>
          <div class="medDoneV">${weekMin}</div>
        </div>
        <div class="medDoneStat">
          <div class="medDoneK">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</div>
          <div class="medDoneV">${fmtMMSS(session.actualSec)}</div>
        </div>
        <div class="medDoneStat">
          <div class="medDoneK">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
          <div class="medDoneV">${compRate}%</div>
        </div>
      `;

      // keep tabs visible but no active; allow buttons
      for(const b of medTabBtns){ b.classList.remove("active"); }
    }

    function renderMedStats(){
      // tiles
      const now = Date.now();
      const weekStart = startOfWeekMs(now);
      const last7 = now - 7*24*60*60*1000;

      const week = medSessions.filter(s => new Date(s.startedAt).getTime() >= weekStart);
      const last7d = medSessions.filter(s => new Date(s.startedAt).getTime() >= last7);

      const total = medSessions.length;
      const totalMin = Math.round(medSessions.reduce((a,s)=>a + (Number(s.actualSec)||0),0) / 60);

      const weekCount = week.length;
      const weekMin = Math.round(week.reduce((a,s)=>a + (Number(s.actualSec)||0),0) / 60);

      const compRate = (arr) => {
        if(!arr.length) return 0;
        const c = arr.filter(s=>s.completed).length;
        return Math.round((c/arr.length)*100);
      };

      const bestHour = (() => {
        if(!medSessions.length) return "‚Äî";
        const buckets = new Array(24).fill(0);
        for(const s of medSessions){
          const h = new Date(s.startedAt).getHours();
          buckets[h] += (Number(s.actualSec)||0);
        }
        let best = 0;
        for(let i=1;i<24;i++) if(buckets[i] > buckets[best]) best = i;
        return String(best).padStart(2,"0") + ":00";
      })();

      const streakDays = (() => {
        if(!medSessions.length) return 0;
        // unique day keys of completed sessions
        const days = Array.from(new Set(medSessions.map(s => dayKeyFromISO(s.startedAt)))).sort();
        // compute longest consecutive
        let best = 1, cur = 1;
        for(let i=1;i<days.length;i++){
          const prev = new Date(days[i-1]).getTime();
          const curMs = new Date(days[i]).getTime();
          const diff = (curMs - prev) / (24*60*60*1000);
          if(diff === 1){
            cur += 1;
            best = Math.max(best, cur);
          }else{
            cur = 1;
          }
        }
        return days.length ? best : 0;
      })();

      medStatsGrid.innerHTML = `
        <div class="medStatCard">
          <div class="medStatK">–ù–∞ –Ω–µ–¥–µ–ª–µ</div>
          <div class="medStatV">${weekCount} —Å–µ—Å—Å–∏–π</div>
          <div class="medStatS">${weekMin} –º–∏–Ω—É—Ç</div>
        </div>
        <div class="medStatCard">
          <div class="medStatK">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ (7 –¥–Ω–µ–π)</div>
          <div class="medStatV">${compRate(last7d)}%</div>
          <div class="medStatS">${last7d.length} —Å–µ—Å—Å–∏–π</div>
        </div>
        <div class="medStatCard">
          <div class="medStatK">–í—Å–µ–≥–æ</div>
          <div class="medStatV">${total} —Å–µ—Å—Å–∏–π</div>
          <div class="medStatS">${totalMin} –º–∏–Ω—É—Ç</div>
        </div>
        <div class="medStatCard">
          <div class="medStatK">–°–∞–º–æ–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è</div>
          <div class="medStatV">${bestHour}</div>
          <div class="medStatS">–ø–æ —Å—É–º–º–µ –º–∏–Ω—É—Ç</div>
        </div>
        <div class="medStatCard" style="grid-column:1 / -1;">
          <div class="medStatK">–°–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Å–µ—Ä–∏—è –¥–Ω–µ–π</div>
          <div class="medStatV">${streakDays} üî•</div>
          <div class="medStatS">–ø–æ –¥–Ω—è–º —Å –º–µ–¥–∏—Ç–∞—Ü–∏–µ–π</div>
        </div>
      `;

      // history
      renderMedHistory();
    }

    function styleLabel(styleKey){
      return (MED.styles[styleKey]?.name) || "–ú–µ–¥–∏—Ç–∞—Ü–∏—è";
    }

    function renderMedHistory(){
      medHistoryBody.innerHTML = "";

      if(!medSessions.length){
        const empty = document.createElement("div");
        empty.className = "emptyBox";
        empty.innerHTML =
          `<div style="font-weight:900; color:var(--text); margin-bottom:6px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–µ—Å—Å–∏–π</div>
           <div>–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—É—é –º–µ–¥–∏—Ç–∞—Ü–∏—é ‚Äî –∏ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</div>`;
        medHistoryBody.appendChild(empty);
        return;
      }

      const sorted = medSessions.slice().sort((a,b) => (a.startedAt < b.startedAt ? 1 : -1)).slice(0, 14);

      for(const s of sorted){
        const row = document.createElement("div");
        row.className = "medHistoryRow";

        const dt = new Date(s.startedAt);
        const when = dt.toLocaleString();

        const minutes = Math.max(1, Math.round((Number(s.actualSec)||0)/60));
        const badgeText = s.completed ? "‚úÖ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" : "‚èπ –¥–æ—Å—Ä–æ—á–Ω–æ";

        row.innerHTML = `
          <div class="medHistoryLeft">
            <div class="medHistoryMain">${styleLabel(s.style)} ‚Ä¢ ${minutes} –º–∏–Ω</div>
            <div class="medHistorySub">${when}</div>
          </div>
          <div class="medHistoryRight">
            <div class="medBadge">${badgeText}</div>
            <div class="medHistorySub">${fmtMMSS(Number(s.actualSec)||0)}</div>
          </div>
        `;
        medHistoryBody.appendChild(row);
      }
    }

    function clearMeditations(){
      const ok = confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–¥–∏—Ç–∞—Ü–∏–π? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if(!ok) return;
      medSessions = [];
      saveMeds();
      renderMedStats();
    }



    // --------- Global UX guards ----------
    document.addEventListener("gesturestart", (e) => e.preventDefault());
    document.addEventListener("gesturechange", (e) => e.preventDefault());
    document.addEventListener("gestureend", (e) => e.preventDefault());

    // --------- Events ----------
    themeBtn.addEventListener("click", toggleTheme);

    entryClose.addEventListener("click", closeEntry);
    entryModalBg.addEventListener("click", (e) => { if(e.target === entryModalBg) closeEntry(); });
    saveEntryBtn.addEventListener("click", saveEntry);

    openJournalBtn.addEventListener("click", openJournal);
    journalClose.addEventListener("click", closeJournal);
    journalModalBg.addEventListener("click", (e) => { if(e.target === journalModalBg) closeJournal(); });

    journalFilter.addEventListener("change", () => {
      journalFilterSegId = journalFilter.value || "";
      openProgressForId = null;
      renderJournal();
    });

    openAffBtn.addEventListener("click", openAff);
    affClose.addEventListener("click", closeAff);
    affModalBg.addEventListener("click", (e) => { if(e.target === affModalBg) closeAff(); });
    affAddBtn.addEventListener("click", addAff);
    affInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        addAff();
      }
    });

    openProgressBtn.addEventListener("click", openProgress);
    progressClose.addEventListener("click", closeProgress);
    progressModalBg.addEventListener("click", (e) => { if(e.target === progressModalBg) closeProgress(); });

    // Meditation events
    openMedBtn.addEventListener("click", openMeditation);
    medClose.addEventListener("click", closeMeditation);
    medModalBg.addEventListener("click", (e) => { if(e.target === medModalBg) closeMeditation(); });

    for(const b of medTabBtns){
      b.addEventListener("click", () => switchMedTab(b.dataset.tab));
    }

    medStyle.addEventListener("change", updateMedPreview);

    medStartBtn.addEventListener("click", beginMeditation);

    medPauseBtn.addEventListener("click", togglePause);

    medStopBtn.addEventListener("click", () => {
      const ok = confirm("–ó–∞–∫–æ–Ω—á–∏—Ç—å –º–µ–¥–∏—Ç–∞—Ü–∏—é –¥–æ—Å—Ä–æ—á–Ω–æ?");
      if(ok) stopMeditation(false);
    });

    medDoneBtn.addEventListener("click", () => {
      medDone.style.display = "none";
      // back to start tab
      switchMedTab("start");
    });

    medDoneToStatsBtn.addEventListener("click", () => {
      medDone.style.display = "none";
      switchMedTab("stats");
    });

    medClearBtn.addEventListener("click", clearMeditations);

    window.addEventListener("resize", () => {
      if(medModalBg.classList.contains("show")){
        updateMedCanvasSize();
      }
    });


    // --------- Resize observer ----------
    const ro = new ResizeObserver(() => {
      updateBottomBarHeight();
      layoutSphere();
      if(progressModalBg.classList.contains("show")){
        renderProgressModal();
      }

      if(medModalBg.classList.contains("show")){
        updateMedCanvasSize();
        if(medRun.style.display !== "none" && medActive){
          // running: canvas loop already
        }else{
          drawMedCanvas(0, "idle");
        }
        if(medTabStats.style.display !== "none"){
          renderMedStats();
        }
      }
    });

    // --------- Boot ----------
    initTheme();
    setVh();
    window.addEventListener("resize", () => { setVh(); updateBottomBarHeight(); layoutSphere(); });
    window.addEventListener("orientationchange", () => { setVh(); updateBottomBarHeight(); layoutSphere(); });

    normalizeStreakOnBoot();
    renderMetrics();
    buildSphere();
    ro.observe(sphereWrap);

    requestAnimationFrame(() => {
      updateBottomBarHeight();
      layoutSphere();
    });

    animate();
  </script>
</body>
</html>
